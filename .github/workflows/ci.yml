name: CI

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  pull-requests: write

jobs:
  test-basic-build:
    name: Test Basic Build (GHCR Only)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test Action - GHCR Only
        uses: ./
        with:
          registry: 'ghcr'
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}
          push-enabled: 'true'
          platforms: 'linux/amd64'
          pr-comment-enabled: 'true'
  
  test-dry-run:
    name: Test Dry Run (No Push)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test Action - Dry Run
        id: test
        uses: ./
        with:
          registry: 'ghcr'
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}
          push-enabled: 'false'
          load-enabled: 'true'
          pr-comment-enabled: 'false'
      
      - name: Validate Outputs
        run: |
          echo "Build Flow Type: ${{ steps.test.outputs.build-flow-type }}"
          echo "Image Tags: ${{ steps.test.outputs.image-tags }}"
          echo "Short SHA: ${{ steps.test.outputs.short-sha }}"
          
          # Validate outputs are not empty
          if [ -z "${{ steps.test.outputs.build-flow-type }}" ]; then
            echo "ERROR: build-flow-type is empty"
            exit 1
          fi
          
          if [ -z "${{ steps.test.outputs.image-tags }}" ]; then
            echo "ERROR: image-tags is empty"
            exit 1
          fi
          
          if [ -z "${{ steps.test.outputs.short-sha }}" ]; then
            echo "ERROR: short-sha is empty"
            exit 1
          fi
          
          echo "‚úÖ All outputs validated successfully"
  
  test-multi-platform:
    name: Test Multi-Platform Build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Test Action - Multi-Platform
        uses: ./
        with:
          registry: 'ghcr'
          ghcr-token: ${{ secrets.GITHUB_TOKEN }}
          platforms: 'linux/amd64,linux/arm64'
          push-enabled: 'true'

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Run ShellCheck on Bash Scripts
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
          echo "üîç Scanning detect-build-flow.sh..."
          shellcheck scripts/detect-build-flow.sh || true
          
          echo "üîç Scanning generate-outputs.sh..."
          shellcheck scripts/generate-outputs.sh || true
          
          echo "‚úÖ ShellCheck scan complete"
      
      - name: Check for Hardcoded Secrets
        run: |
          echo "üîç Checking for potential hardcoded secrets..."
          
          # Look for common secret patterns (excluding test files)
          if grep -r -E "(password|secret|token|api[_-]?key)\s*=\s*['\"][^'\"]+['\"]" \
             --include="*.sh" --include="*.js" --include="*.yml" \
             --exclude-dir=".git" --exclude="test-action.yml" .; then
            echo "‚ö†Ô∏è  WARNING: Potential hardcoded secrets found (review above)"
          else
            echo "‚úÖ No hardcoded secrets detected"
          fi
      
      - name: Validate Action Schema
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            try {
              const actionYml = yaml.load(fs.readFileSync('action.yml', 'utf8'));
              
              // Validate required fields
              if (!actionYml.name) throw new Error('Missing: name');
              if (!actionYml.description) throw new Error('Missing: description');
              if (!actionYml.runs) throw new Error('Missing: runs');
              
              console.log('‚úÖ action.yml schema is valid');
            } catch (error) {
              core.setFailed(`Schema validation failed: ${error.message}`);
            }
